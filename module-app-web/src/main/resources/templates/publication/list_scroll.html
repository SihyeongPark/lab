<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- css -->
    <th:block th:replace="layout/css.html"></th:block>

    <title>Publication List</title>
</head>
<body>
<!-- header -->
<div th:replace="layout/header::header"></div>

<div class="container-md">
    <form name="form" id="form" th:object="${publicationSearchDto}" action="#">
        <div class="page-header">
            <h1>Publication List</h1>
        </div>
        <div class="row justify-content-md-end mt-md-5">
            <div class="custom-control custom-radio mx-md-2">
                <input type="radio" class="custom-control-input" name="publicationSearchType" id="showAll"
                       th:value="SHOW_ALL"
                       th:checked="*{publicationSearchType?.name() == 'SHOW_ALL' ||  publicationSearchType?.name() == null}">
                <label class="custom-control-label" th:for="showAll"> Show All </label>
            </div>
            <div class="custom-control custom-radio mx-md-2">
                <input type="radio" class="custom-control-input" name="publicationSearchType" id="internationalJournal"
                       th:value="INTERNATIONAL_JOURNAL"
                       th:checked="*{publicationSearchType?.name() == 'INTERNATIONAL_JOURNAL'}">
                <label class="custom-control-label" th:for="internationalJournal"> International Journal </label>
            </div>
            <div class="custom-control custom-radio mx-md-2">
                <input type="radio" class="custom-control-input" name="publicationSearchType"
                       id="internationalConference"
                       th:value="INTERNATIONAL_CONFERENCE"
                       th:checked="*{publicationSearchType?.name() == 'INTERNATIONAL_CONFERENCE'}">
                <label class="custom-control-label" th:for="internationalConference"> International Conference </label>
            </div>
            <div class="custom-control custom-radio mx-md-2">
                <input type="radio" class="custom-control-input" name="publicationSearchType" id="domesticJournal"
                       th:value="DOMESTIC_JOURNAL"
                       th:checked="*{publicationSearchType?.name() == 'DOMESTIC_JOURNAL'}">
                <label class="custom-control-label" th:for="domesticJournal"> Domestic Journal </label>
            </div>
            <div class="custom-control custom-radio mx-md-2">
                <input type="radio" class="custom-control-input" name="publicationSearchType" id="domesticConference"
                       th:value="DOMESTIC_CONFERENCE"
                       th:checked="*{publicationSearchType?.name() == 'DOMESTIC_CONFERENCE'}">
                <label class="custom-control-label" th:for="domesticConference"> Domestic Conference </label>
            </div>
        </div>

        <div class="row justify-content-md-end mt-md-2">
            <div class="col-md1 my-md-1 mx-md-1 align-middle">
                <select name="searchType" th:field="*{searchType}" class="form-control input-sm">
                    <option th:value="TITLE">title</option>
                    <option th:value="AUTHORS">authors</option>
                    <option th:value="PUBLISHED_IN">published in</option>
                </select>
            </div>
            <div class="col-md1 my-md-1 mx-md-1">
                <input type="text" name="keyword" class="form-control" th:value="${searchDto?.keyword}"/>
            </div>
            <div class="col-md1 my-md-1 mx-md-1">
                <button id="search" type="button" class="btn btn-primary">Search</button>
            </div>
        </div>

        <br/>
        <div id="main">
            <div th:id="publicationData0" th:each="publicationDto : ${publicationDtoList}" th:class="my-md-4">
                <a th:href="${publicationDto.uri}" th:id="publicationTitle" class="my-md-1" th:text="${publicationDto.title}" th:class="title"></a><br>
                <span th:text="${publicationDto.authors}" th:id="publicationAuthors" class="authors my-md-1"></span><br>

                <span th:if="!${#strings.isEmpty(publicationDto.publishedIn)}" th:text="${publicationDto.publishedIn}"></span>
                <span th:if="!${#strings.isEmpty(publicationDto.publishedDate)}" th:text="', ' + ${#temporals.format(publicationDto.publishedDate, 'MMMM', new java.util.Locale('en', 'EN'))}"></span>
                <span th:if="!${#strings.isEmpty(publicationDto.publishedDate)}" th:text="', ' + ${#temporals.format(publicationDto.publishedDate,'yyyy')}"></span>
                <span th:if="!${#strings.isEmpty(publicationDto.volume)}" th:text="', Vol. ' + ${publicationDto.volume} "></span>
                <span th:if="!${#strings.isEmpty(publicationDto.number)}" th:text="', No. ' + ${publicationDto.number}"></span>
                <span th:if="!${#strings.isEmpty(publicationDto.pages)}" th:text="', pp. ' + ${publicationDto.pages}"></span>
                <span th:if="!${#strings.isEmpty(publicationDto.isbnIssn)}" th:text="', ' + ${publicationDto.isbnIssn}"></span>

                <p class="my-md-1">
                    <span th:if="${#strings.equals(publicationDto.publishingArea, 'INTERNATIONAL') && #strings.equals(publicationDto.publicationType, 'JOURNAL')}" th:text="${publicationDto.publishingArea.publishingArea} + ' ' + ${publicationDto.publicationType.publicationType} + (${#strings.isEmpty(publicationDto.impactFactor)} ? '' : ${publicationDto.impactFactor})" class="btn btn-primary btn-sm"></span>
                    <span th:if="${#strings.equals(publicationDto.publishingArea, 'INTERNATIONAL') && !(#strings.equals(publicationDto.publicationType, 'JOURNAL'))}" th:text="${publicationDto.publishingArea.publishingArea} + ' ' + ${publicationDto.publicationType.publicationType}" class="btn btn-info btn-sm"></span>
                    <span th:if="${#strings.equals(publicationDto.publishingArea, 'DOMESTIC') && #strings.equals(publicationDto.publicationType, 'JOURNAL')}" th:text="${publicationDto.publishingArea.publishingArea} + ' ' + ${publicationDto.publicationType.publicationType} " class="btn btn-success btn-sm"></span>
                    <span th:if="${#strings.equals(publicationDto.publishingArea, 'DOMESTIC') && !(#strings.equals(publicationDto.publicationType, 'JOURNAL'))}" th:text="${publicationDto.publishingArea.publishingArea} + ' ' + ${publicationDto.publicationType.publicationType}" class="btn btn-warning btn-sm" style="color:white;"></span>
                </p>
            </div>
        </div>
        <br>

        <p id="loading">
            <img th:src="@{/images/loading.gif}" alt="Loading…"/>
        </p>
    </form>
</div>

<!-- footer -->
<div th:replace="layout/footer::footer"></div>

<!-- script file -->
<th:block th:replace="layout/script.html"></th:block>

<script th:inline="javascript">
    var list = ([[${publicationDtoList}]]);
    var lastIdx = 0;
    var isLast = false;
    var uri = null;

    // 조회하는 데이터가 10개 보다 적은 경우 loading.gif를 hide
    if (list.length < 10) {
        $("#loading").hide();
    }
    // 처음 발생하는 scroll event에서 데이터를 가져오는 기준이 된다.(마지막 배열 요소의 idx)
    else {
        lastIdx = list[list.length - 1].idx;
    }

    $(document).ready(function () {
        var win = $(window);
        var publicationId = 1;

        // Each time the user scrolls
        win.scroll(function () {
            if ($(window).scrollTop() + $(window).height() > $(document).height() - 100) {
                // 더이상 가져오는 데이터가 없는 경우
                if (isLast) {
                    $('#loading').hide();
                    return;
                }

                $('#loading').show();

                // 처음과 마지막 데이터가 중복되는 경우를 제거하기 위해서 lastIdx에서 1을 뺀다.
                uri = {lastIdx: lastIdx - 1};

                // URI 생성
                Object.assign(uri, getUriParams());
                uri = makeGetUri("http://175.213.188.61:8081/api/publications/list_scroll", uri);

                $.ajax({
                    url: uri,
                    type: "get",
                    dataType: "text",
                    contentType: "application/json",
                    async: false,
                })
                    .done(function (msg) {
                        var publicationList = JSON.parse(msg);
                        // 가져오는 데이터가 없는 경우
                        if (publicationList.length == 0) {
                            isLast = true;
                            return;
                        }

                        // 다음 발생하는 scroll event에서 데이터를 가져오는 기준이 된다.(마지막 배열 요소의 idx)
                        lastIdx = (JSON.parse(msg))[(JSON.parse(msg)).length - 1].idx;

                        setTimeout(function () {
                            $('#loading').hide();
                        }, 2500);

                        // ajax를 통하여 받은 데이터를 html에 출력한다.
                        var monthNames = ["January", "February", "March", "April", "May", "June",
                            "July", "August", "September", "October", "November", "December"
                        ];

                        for(var i = 0; i < publicationList.length; i++) {
                            var str = null;
                            var publishedDate = publicationList[i].publishedDate.split('-');
                            publishedDate[1] = monthNames[publishedDate[1] - 1];

                            if (publicationList[i].publishingArea == 'INTERNATIONAL' && publicationList[i].publicationType == 'JOURNAL') {
                                str = "<span class='btn btn-primary btn-sm'>" + capitalize(publicationList[i].publishingArea) + ' ' + capitalize(publicationList[i].publicationType) + '-' + publicationList[i].impactFactor + "</span>";
                            } else if(publicationList[i].publishingArea == 'INTERNATIONAL' && !(publicationList[i].publicationType == 'JOURNAL')){
                                str = "<span class='btn btn-info btn-sm'>" + capitalize(publicationList[i].publishingArea) + ' ' + capitalize(publicationList[i].publicationType) + "</span>";
                            } else if(publicationList[i].publishingArea == 'DOMESTIC' && publicationList[i].publicationType == 'JOURNAL'){
                                str = "<span class='btn btn-success btn-sm'>" + capitalize(publicationList[i].publishingArea) + ' ' + capitalize(publicationList[i].publicationType) + "</span>";
                            } else if(publicationList[i].publishingArea == 'DOMESTIC' && !(publicationList[i].publicationType == 'JOURNAL')){
                                str = "<span class='btn btn-warning btn-sm'>" + capitalize(publicationList[i].publishingArea) + ' ' + capitalize(publicationList[i].publicationType) + "</span>";
                            } else {
                                str="";
                            }

                            $("#main").append('<div id="publicationData' +  publicationId + ' class="my-md-4">'
                                + '<a id="publicationTitle"' +  publicationId + ' href="publicationList[i].uri" class="my-md-1 title">' + publicationList[i].title + '</a><br>'
                                + '<span id="publicationAuthors"' +  publicationId + ' class="authors my-md-1">' + publicationList[i].authors + '</span><br>'
                                + '<span>' + publicationList[i].publishedIn + '</span>'
                                + '<span>, ' + publishedDate[1] + '</span>'
                                + '<span>, ' + publishedDate[0] + '</span>'
                                + '<span>, Vol. ' + publicationList[i].volume + '</span>'
                                + '<span>, No. ' + publicationList[i].number + '</span>'
                                + '<span>, pp. ' + publicationList[i].pages + '</span>'
                                + '<span>, ' + publicationList[i].isbnIssn + '</span>'
                                + '<p class="my-md-1">'
                                + str
                                + '</p>'
                                + '</div>'
                                + '<br>');

                            publicationId++;
                        }


                    })
                    .fail(function (msg) {
                        console.log("Fail to get data.");
                        $('#loading').hide();
                    })
            }
        });
    });

    $("#search").click(function () {
        document.form.action = "/publication/list_scroll";
        document.form.method = "get";
        document.form.submit();
    });
</script>

</body>
</html>